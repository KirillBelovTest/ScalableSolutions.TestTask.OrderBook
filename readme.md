# Тестирование биржевого стакана

## 1. Выполнить исследование предметной области

Ответьте для себя на следующие вопросы:

1. Что такое биржевой стакан и какими свойствами он обычно обладает
2. Что такое заявка и какие ее основные параметры

## _Ответ_

Отвечая на этот вопрос - я руководствуюсь своим опытом работы с 
криптовалютными биржами. 

Ордер - некая атомарная единица в торгах на бирже. Я бы сказал, что 
на низком уровне это некая запись в таблице, о том, что трейдер готов продать 
некоторое количество ценных бумаг `quantity`, которые принадлежат ему 
по цене `price`. На абстрактном уровне - ордер - это просто товар (предмет торга) 
со своим ценником. Кроме цены и доступного для трейдера количества товара, 
ордера обычно помечаются уникальным идентификатором `id`, и обладают другими 
свойствами, которые дают больше информации об ордере. Например:
- время создания
- пара - что продается и на что меняется - например RUR-USD
- "направление" - т.е. это ордер на продажу (рублей) 
или на покупку (рублей же) за доллары (здесь мы принимает рубль базовой валютойы, 
т.е. рубль - это предмет торга)
- тип - один из доступных на бирже (limit, stop-loss, ...). 
Обычно (насколько я знаю) фактически сущестуют только лимитные ордера, 
остальные типы реализуются алгоритмами открытия и перестановки ордеров
- текущий статус (открыт, закрыт, закрыт частично, отменен)

Насколько я знаю - "биржевой стакан" - меняющаяся в реальном времени таблица, 
в которой находятся все выставленный на данный момент заявки (ордера). 
Стакан делится на две части: ордера на продажу и на покупку. Они обычно 
сортируются по указанной в ордере цене - сверху наиболее дорогие ордера на 
продажу. А снизу наиболее дешевые ордера на покупку. В этом списке ордеров 
существует разрыв, который является переходом от покупке к продаже. 
Насколько я знаю, обычно "зазор" между самым дорогим ордером на покупку и 
самым дешевым ордером на продажу называют "спред". Этот разрыв показывает 
текущую рыночную цену. Т.е. по моим представлениям текущая рыночная цена - 
это число, которое может быть определено только с некоторым допуском. 
Либо можно определить две рыночные цены - рыночная цена покупки - 
цена самого дешевого ордера на продажу и рыночная цена продажи - 
самый дорогой ордер на покупку. Величина спреда может характеризовать 
интенсивность торгов. Там где спред очень большой - 
торги идут медленно и рыночная цена изменяется медленно. Плюс фактически 
есть большая разнница между покупкой и продажей. Это свойство 
(величина спреда) активно используют высокочастотные трейдеры, 
которые торгуют при помощи ботов. Эта одна из самых примитивных 
методик автоматических торгов называется "скальпинг" 
(я реализовывал бота, который торгует используя скальпинг). 
Ее основной принцип состоит в том, что нужный трейдеру ордер автоматически 
переставляется всегда на самый верх/низ стакана (в зависимости от типа) 
так, чтобы при первой покупке/продаже этот ордер сработал бы самым первым. 
Как только ордер срабатывает - проиходит тот же процесс, 
но уже с обратной стороны. Эта методика будет эффективна только в случае, 
если относительный размер спреда больше чем 2*коммисию биржы. 
Самое забавное - это наблюдать за борьбой ботов, которые каждую долю секунды 
перебивают ордера друг друга (определить что это боты легко если понаблюдать 
за скоростью и точностью перестановки ордеров там, где торги медленные). 
Но я отвлекся. У стакана есть общий объем, объем продажи и объем покупки. 
А также минимальные и максимальные цены продажи/покупки. 
Также, если визуально понаблюдать за стаканом, то по нему можно определить 
текущее состояние торгов для текущей пары бумаг/валют. Большой объем 
и большие ордера на продажу высоко над спредом означают, что "рынок перекуплен", 
соответственно наборот когда очень много ордеров значительно дешевле 
рыночной цены покупки - "рынок перепродан". 

Как работает стакан. Есть текущая рыночная цена покупки и продажи - 
это два ордера на продажу/покупки между которыми самая небольшая разница. 
Как только появляется трейдер, у которого не выдерживают нервы и он решает 
например выставить ордер на покупку по цене выше рыночной продажи - 
то его ордер в зависимости от соотношения объемов либо "аннигилирует" 
(насколько я понимаю именно это имеется ввиду по "сведением" заявок) 
с ближайшим ордером на продажу, либо частично уменьшает его объем, либо 
уменьшает свой объем на размер ближайшего ордера на продажу. 
Если же цена следующего ордера на продажу имеет цену выше, чем цена 
того ордера, который мы рассматриваем - то он не исчезает полностью, 
а часть от него остается в стакане. Таким образом появляется новая рыночная цена. 
На бирже этот процесс идет непрерывно и цена постоянно двигается. 
Когда появляется множество трейдеров готовых купить выше текущей рыночной цены - 
цена бумаги начинается резко расти. Или падать, когда возникает большое число 
трейдеров готовых продавать ниже рыночной цены. 

## 2. Реализация биржевого стакана на Python (order_book.py)

Напишите класс OrderBook, реализующий упрощенный биржевой стакан. Класс должен 
обеспечивать следующую функциональность:

1. Постановка заявок в стакан - реализовывать логику сведения заявок не требуется. 
Набор параметров заявки определяется кандидатом самостоятельно
2. Снятие заявок по идентификатору заявки
3. Получение данных заявки по идентификатору
4. Получение снапшота рыночных данных (market data). Данные стакана должны быть 
агрегированы и отсортированы по цене в виде словаря следующей структуры:

```python
{
    "asks": [
        {
            "price": <value>,
            "quantity": <value>
        },
        ...
    ],
    "bids": [...]
}
```

5. Код должен быть документированным.

## 3. Реализация тестов для биржевого стакана (test_order_book.py)

Напишите тесты для Вашего класса OrderBook на Python с использование фреймворка
Pytest.

1. Скрипт должен содержать набор функций, проверяющих корректность работы 
класса, на соответствие заданию и логике заложенной Вами.
2. Результаты тестирования должны выводиться в консоль в читабельном формате.

## 4. Результаты

1. Разработка должна вестись с применением системы контроля версий git в 
локальном репозитории (выкладывать скрипты на Github и другие сервисы не 
нужно).
2. Результаты Вашей работы вместе с папкой .git должны быть запакованы в архив и 
направлены нашим HR.
